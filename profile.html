<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Profile - SkilWise</title>
    <link rel="stylesheet" href="/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    
    <script>
        window.supabase = supabase.createClient(
            'https://ovqkuwbjstovqjjtrwny.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im92cWt1d2Jqc3RvdnFqanRyd255Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDA0OTY5NzUsImV4cCI6MjA1NjA3Mjk3NX0.zEXoXzlyOyE4UvPI7yIzXKOAkjhZv0gYwA35ycwRiPw'
        );
    </script>
</head>
<body>
    <header>
        <a href="index.html" class="logo">
            <img src="/images/SkilWise Logo.png" alt="SkilWise Logo">
        </a>
        <nav>
            <input type="checkbox" id="menu-toggle" class="menu-toggle">
            <label for="menu-toggle" class="menu-icon">Menu ☰</label>
            <ul>
                <li><a href="dashboard.html">Dashboard</a></li>
                <li><a href="profile.html" class="profile-btn">Profile</a></li>
                <li><button class="logout-btn" id="logoutButton">Logout</button></li>
            </ul>
        </nav>
    </header>

    <main class="profile-container">
        <h1>Your Candidate Profile</h1>
        <button id="toggleEdit" class="edit-btn">Edit Profile</button>
        
        <form id="profileForm" class="read-mode">
            <div class="profile-section">
                <h2>Personal Information</h2>
                <div class="form-group">
                    <label>Full Name:</label>
                    <span class="view-mode"></span>
                    <input type="text" class="edit-mode" id="fullName" required>
                </div>
                <div class="form-group">
                    <label>Professional Title:</label>
                    <span class="view-mode"></span>
                    <input type="text" class="edit-mode" id="jobTitle">
                </div>
                <div class="form-group">
                    <label>Location:</label>
                    <span class="view-mode"></span>
                    <input type="text" class="edit-mode" id="location">
                </div>
                <!-- ADDED: Contact Details -->
                <div class="form-group">
                    <label>Email:</label>
                    <span class="view-mode"></span>
                    <input type="email" class="edit-mode" id="email" />
                </div>
                <div class="form-group">
                    <label>Phone:</label>
                    <span class="view-mode"></span>
                    <input type="text" class="edit-mode" id="phone" />
                </div>
                <div class="form-group">
                    <label>LinkedIn:</label>
                    <span class="view-mode"></span>
                    <input type="text" class="edit-mode" id="linkedin" />
                </div>
            </div>

            <!-- ADDED: Professional Summary Section -->
            <div class="profile-section">
                <h2>Professional Summary</h2>
                <div class="form-group">
                <label></label>
                <span class="view-mode"></span>
                <textarea class="edit-mode" id="summary" rows="4" placeholder="Write a short bio"></textarea>
                </div>
            </div>

            <div class="profile-section">
                <h2>Skills & Expertise</h2>
                <div id="skillsContainer" class="tags-container"></div>
                <button type="button" class="add-more edit-mode" id="addSkill">+ Add Skill</button>
            </div>

            <!-- ADDED: Certifications Section -->
            <div class="profile-section">
                <h2>Certifications</h2>
                <div id="certificationsContainer" class="tags-container"></div>
                <button type="button" class="add-more edit-mode" id="addCertification">+ Add Certification</button>
            </div>

            <div class="profile-section">
                <h2>Work Experience</h2>
                <div id="experienceContainer"></div>
                <button type="button" class="add-more edit-mode" id="addExperience">+ Add Experience</button>
            </div>

            <div class="profile-section">
                <h2>Education</h2>
                <div id="educationContainer"></div>
                <button type="button" class="add-more edit-mode" id="addEducation">+ Add Education</button>
            </div>

              <!-- ADDED: Job Preferences Section -->
            <div class="profile-section">
                <h2>Job Preferences</h2>
                <div class="form-group">
                    <label>Preferred Job Roles:</label>
                    <div class="view-mode" id="preferredjobroles-view"></div>
                    <input type="text" class="edit-mode" id="preferredjobroles" placeholder="e.g., Developer, Manager" />
                </div>
                <div class="form-group">
                    <label>Industries of Interest:</label>
                    <div class="view-mode" id="industries-view"></div>
                    <input type="text" class="edit-mode" id="industries" placeholder="e.g., Tech, Finance" />
                </div>
                <div class="form-group">
                    <label>Employment Type:</label>
                    <div class="view-mode" id="employmenttype-view"></div>
                    <input type="text" class="edit-mode" id="employmenttype" placeholder="e.g., Full-time, Part-time" />
                </div>
                <div class="form-group">
                    <label>Preferred Locations:</label>
                    <div class="view-mode" id="preferredlocations-view"></div>
                    <input type="text" class="edit-mode" id="preferredlocations" placeholder="e.g., Remote, Onsite" />
                </div>
            </div>

            <!-- ADDED: Languages Section -->
            <div class="profile-section">
                <h2>Languages</h2>
                <div id="languagesContainer" class="tags-container"></div>
                <button type="button" class="add-more edit-mode" id="addLanguage">+ Add Language</button>
            </div>

            <!-- ADDED: Social Media Section -->
            <div class="profile-section">
                <h2>Social Media</h2>
                <div id="socialmediaContainer" class="tags-container"></div>
                <button type="button" class="add-more edit-mode" id="addSocialmedia">+ Add Social Media</button>
            </div>

            <!-- ADDED: Volunteer Experience Section -->
            <div class="profile-section">
                <h2>Volunteer Experience</h2>
                <div id="volunteerContainer"></div>
                <button type="button" class="add-more edit-mode" id="addVolunteer">+ Add Volunteer Experience</button>
            </div>

            <!-- ADDED: Projects & Portfolio Section -->
            <div class="profile-section">
                <h2>Projects & Portfolio</h2>
                <div id="projectsContainer"></div>
                <button type="button" class="add-more edit-mode" id="addProject">+ Add Project</button>
            </div>

            <div class="form-actions edit-mode">
                <button type="submit" class="save-btn">Save Changes</button>
                <button type="button" class="cancel-btn" id="cancelEdit">Cancel</button>
            </div>
        </form>
        <!-- Skill Modal -->
        <div id="skillModal" class="modal">
            <div class="modal-content">
                <h3>Select a Skill</h3>
                <!-- Searchable Dropdown -->
                <div class="searchable-dropdown">
                    <input type="text" id="skillSearch" class="skill-search" placeholder="Search for a skill..." />
                    <ul id="skillDropdown" class="dropdown-list">
                        <!-- Options will be dynamically populated -->
                    </ul>
                </div>
                <div class="modal-actions">
                    <button id="confirmSkillButton" class="btn-primary">Add Skill</button>
                    <button id="cancelSkillButton" class="btn-secondary">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Skill Removal Confirmation Modal -->
        <div id="removeSkillModal" class="skill-removal-modal">
            <div class="modal-content">
                <h2>⚠️ <strong>Warning!</strong> ⚠️</h2>
                <h3>Are you sure you want to remove this skill?</h3>
                <p>If you proceed, you may lose your verified status and any test score associated with it (if any).<br><br>

                    <strong>This action cannot be undone!</strong></p>
                    <h3>⚠️ <strong>Proceed with caution!</strong> ⚠️</h3>
                <div class="modal-actions">
                    <button id="confirmRemoveSkillButton" class="btn-danger">Remove Skill</button>
                    <button id="cancelRemoveSkillButton" class="btn-secondary">Keep Skill</button>
                </div>
            </div>
        </div>
    </main>

    <script>
        const supabase = window.supabase;
        let profileData = {};

        // ADDED: Extend profileData defaults for new sections
        const defaultProfileData = {
        user_id: "",
        full_name: "",
        job_title: "",
        location: "",
        email: "",
        phone: "",
        linkedin: "",
        summary: "",
        skills: [],
        certifications: [],
        experience: [],
        education: [],
        preferredjobroles: "",
        industries: "",
        employmenttype: "",
        preferredlocations: "",
        languages: [],
        socialmedia: [],
        volunteer: [],
        projects: []
        };


        // Auth Check
        async function checkAuth() {
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) window.location.href = 'login.html';
            return user;
        }

        // Navigation Update
        async function updateNavigation() {
            const user = await checkAuth();
            const profileLink = document.querySelector('.profile-btn');
            profileLink.style.display = user ? 'block' : 'none';
        }

        // Profile Data Handling
        async function initializeProfile() {
            const user = await checkAuth();
            
            const { data } = await supabase
                .from('candidate_profiles')
                .select('*')
                .eq('user_id', user.id)
                .single();

            profileData = data || Object.assign({}, defaultProfileData, {
                user_id: user.id,
                full_name: user.user_metadata.full_name || '',
                email: user.email || ''
                
            });

            populateForm();
            setupEventListeners();
        }

        function populateForm() {
            // Personal Info
            document.querySelectorAll('.view-mode')[0].textContent = profileData.full_name;
            document.getElementById('fullName').value = profileData.full_name;
            document.querySelectorAll('.view-mode')[1].textContent = profileData.job_title || '';
            document.getElementById('jobTitle').value = profileData.job_title || '';
            document.querySelectorAll('.view-mode')[2].textContent = profileData.location || '';
            document.getElementById('location').value = profileData.location || '';
            // ADDED: Contact Details
            document.querySelectorAll('.view-mode')[3].textContent = profileData.email;
            document.getElementById('email').value = profileData.email;
            document.querySelectorAll('.view-mode')[4].textContent = profileData.phone || '';
            document.getElementById('phone').value = profileData.phone || '';
            document.querySelectorAll('.view-mode')[5].textContent = profileData.linkedin || '';
            document.getElementById('linkedin').value = profileData.linkedin || '';

            // ADDED: Professional Summary
            document.querySelectorAll('.view-mode')[6].textContent = profileData.summary || '';
            document.getElementById('summary').value = profileData.summary || '';

            // Render Skills
            renderSkills();

            // ADDED: Certifications Section
            renderCertifications();

            // Experience
            const expContainer = document.getElementById('experienceContainer');
            expContainer.innerHTML = (profileData.experience || []).map(exp => `
                <div class="experience-item">
                    <div class="view-mode">
                        <h3>${exp.position || ''} | ${exp.company || ''}</h3>
                        <h4>${exp.duration || ''}</h4>
                        <p>${exp.description || ''}</p>
                    </div>
                    <div class="edit-mode">
                        <input type="text" class="edit-mode company" value="${exp.company || ''}" placeholder="Company">
                        <input type="text" class="edit-mode position" value="${exp.position || ''}" placeholder="Position">
                        <input type="text" class="edit-mode duration" value="${exp.duration || ''}" placeholder="Duration">
                        <textarea class="edit-mode description" placeholder="Description" rows="4">${exp.description || ''}</textarea>
                        <button type="button" class="remove-item">Remove</button>
                    </div>
                </div>
            `).join('');

            // Education
            const eduContainer = document.getElementById('educationContainer');
            eduContainer.innerHTML = (profileData.education || []).map(edu => `
                <div class="education-item">
                    <div class="view-mode">
                        <h3>${edu.degree || ''} | ${edu.institution || ''}</h3>
                        <p>${edu.field || ''} | ${edu.year || ''}</p>
                    </div>
                    <div class="edit-mode">
                        <input type="text" class="edit-mode institution" value="${edu.institution || ''}" placeholder="Institution">
                        <input type="text" class="edit-mode degree" value="${edu.degree || ''}" placeholder="Degree">
                        <input type="text" class="edit-mode field" value="${edu.field || ''}" placeholder="Field">
                        <input type="integer" class="edit-mode year" value="${edu.year || ''}" placeholder="GraduationYear">
                        <button type="button" class="remove-item">Remove</button>
                    </div>
                </div>
            `).join('');

            // ADDED: Job Preferences
            document.querySelector('.view-mode#preferredjobroles-view').textContent = profileData.preferredjobroles || '';
            document.getElementById('preferredjobroles').value = profileData.preferredjobroles || '';
            
            document.querySelector('.view-mode#industries-view').textContent = profileData.industries || '';
            document.getElementById('industries').value = profileData.industries || '';

            document.querySelector('.view-mode#employmenttype-view').textContent = profileData.employmenttype || '';
            document.getElementById('employmenttype').value = profileData.employmenttype || '';

            document.querySelector('.view-mode#preferredlocations-view').textContent = profileData.preferredlocations || '';
            document.getElementById('preferredlocations').value = profileData.preferredlocations || '';

            // ADDED: Languages
            renderLanguages();

            // ADDED: Social Media
            renderSocialmedia();

            // ADDED: Volunteer Experience
            renderVolunteer();

            // ADDED: Projects & Portfolio
            renderProjects();

        }

        // ADDED: Render Functions for New Sections

        function renderCertifications() {
            const container = document.getElementById('certificationsContainer');
            container.innerHTML = (profileData.certifications || []).map(cert => `
                <div class="certification-item">
                <div class="view-mode">
                    <p><strong>${cert.name || ''}</strong> - ${cert.institution || ''}</p>
                    <p>Issued: ${cert.issueDate || ''} ${cert.expiryDate ? ('| Expires: ' + cert.expiryDate) : ''}</p>
                </div>
                <div class="edit-mode">
                    <input type="text" class="edit-mode cert-name" value="${cert.name || ''}" placeholder="Certificate Name">
                    <input type="text" class="edit-mode cert-institution" value="${cert.institution || ''}" placeholder="Certifying Institution">
                    <input type="date" class="edit-mode cert-issueDate" value="${cert.issueDate || ''}" placeholder="Issue Date">
                    <input type="date" class="edit-mode cert-expiryDate" value="${cert.expiryDate || ''}" placeholder="Expiry Date (Optional)">
                    <button type="button" class="remove-item">Remove</button>
                </div>
                </div>
            `).join('');
        }

        function renderLanguages() {
            const container = document.getElementById('languagesContainer');
            container.innerHTML = (profileData.languages || []).map(lang => `
                <div class="language-item">
                <div class="view-mode">
                    <p><strong>${lang.name || ''}</strong> - ${lang.proficiency || ''}</p>
                </div>
                <div class="edit-mode">
                    <input type="text" class="edit-mode language-name" value="${lang.name || ''}" placeholder="Language">
                    <input type="text" class="edit-mode language-proficiency" value="${lang.proficiency || ''}" placeholder="Proficiency">
                    <button type="button" class="remove-item">Remove</button>
                </div>
                </div>
            `).join('');
        }

        function renderSocialmedia() {
            const container = document.getElementById('socialmediaContainer');
            container.innerHTML = (profileData.socialmedia || []).map(sm => `
                <div class="social-item">
                <div class="view-mode">
                    <p><strong>${sm.platform || ''}</strong> - ${sm.link || ''}</p>
                </div>
                <div class="edit-mode">
                    <input type="text" class="edit-mode social-platform" value="${sm.platform || ''}" placeholder="Platform Name">
                    <input type="text" class="edit-mode social-link" value="${sm.link || ''}" placeholder="Profile Link">
                    <button type="button" class="remove-item">Remove</button>
                </div>
                </div>
            `).join('');
        }

        function renderVolunteer() {
            const container = document.getElementById('volunteerContainer');
            container.innerHTML = (profileData.volunteer || []).map(vol => `
                <div class="volunteer-item">
                <div class="view-mode">
                    <p><strong>${vol.role || ''}</strong> at ${vol.organisation || ''}</p>
                    <p>${vol.description || ''}</p>
                </div>
                <div class="edit-mode">
                    <input type="text" class="edit-mode volunteer-role" value="${vol.role || ''}" placeholder="Role Title">
                    <input type="text" class="edit-mode volunteer-org" value="${vol.organisation || ''}" placeholder="Organisation">
                    <textarea class="edit-mode volunteer-desc" placeholder="Description" rows="3">${vol.description || ''}</textarea>
                    <button type="button" class="remove-item">Remove</button>
                </div>
                </div>
            `).join('');
        }

        function renderProjects() {
            const container = document.getElementById('projectsContainer');
            container.innerHTML = (profileData.projects || []).map(proj => `
                <div class="project-item">
                <div class="view-mode">
                    <p><strong>${proj.name || ''}</strong></p>
                    <p>${proj.description || ''}</p>
                    <p><a href="${proj.link || '#'}" target="_blank">${proj.link || ''}</a></p>
                </div>
                <div class="edit-mode">
                    <input type="text" class="edit-mode project-name" value="${proj.name || ''}" placeholder="Project Name">
                    <textarea class="edit-mode project-desc" placeholder="Short Description" rows="3">${proj.description || ''}</textarea>
                    <input type="text" class="edit-mode project-link" value="${proj.link || ''}" placeholder="Project Link">
                    <button type="button" class="remove-item">Remove</button>
                </div>
                </div>
            `).join('');
        }



        // Event Handlers
        function setupEventListeners() {
            // Edit Mode Toggle
            document.getElementById('toggleEdit').addEventListener('click', () => {
                document.getElementById('profileForm').classList.add('edit-mode-active');
            });

            // Cancel Edit
            document.getElementById('cancelEdit').addEventListener('click', () => {
                document.getElementById('profileForm').classList.remove('edit-mode-active');
                populateForm();
            });

            // Form Submission
            document.getElementById('profileForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = getFormData();

                console.log('Form Data to save:', formData); // Debug log

                const { data, error } = await supabase
                    .from('candidate_profiles')
                    .upsert(formData, { onConflict: 'user_id'});

                if (error) {
                    console.error('Error saving profile:', error);
                    alert('Error saving profile. Check console for details.');
                } 
                else {
                    profileData = formData;
                    document.getElementById('profileForm').classList.remove('edit-mode-active');
                    populateForm();
                }
            });

            // Dynamic Field Handling
            document.getElementById('addSkill').addEventListener('click', addSkill);
            document.getElementById('addExperience').addEventListener('click', addExperience);
            document.getElementById('addEducation').addEventListener('click', addEducation);

            // ADDED: New dynamic field event listeners
            document.getElementById('addCertification').addEventListener('click', addCertification);
            document.getElementById('addLanguage').addEventListener('click', addLanguage);
            document.getElementById('addSocialmedia').addEventListener('click', addSocialmedia);
            document.getElementById('addVolunteer').addEventListener('click', addVolunteer);
            document.getElementById('addProject').addEventListener('click', addProject);

            document.querySelectorAll('.remove-skill, .remove-item').forEach(btn => {
                btn.addEventListener('click', removeItem);
            });
        }

        // Helper Functions
        function getFormData() {
            return {
                user_id: profileData.user_id,
                full_name: document.getElementById('fullName').value,
                job_title: document.getElementById('jobTitle').value,
                location: document.getElementById('location').value,
                // ADDED: Contact Details
                email: document.getElementById('email').value,             // ADDED
                phone: document.getElementById('phone').value,             // ADDED
                linkedin: document.getElementById('linkedin').value,       // ADDED
                summary: document.getElementById('summary').value,         // ADDED
                // existing skills
                skills: profileData.skills,
                // ADDED: Certifications
                certifications: Array.from(document.querySelectorAll('.certification-item')).map(item => ({
                name: item.querySelector('.cert-name').value || item.querySelector('.view-mode p strong').textContent,
                institution: item.querySelector('.cert-institution').value,
                issueDate: item.querySelector('.cert-issueDate').value,
                expiryDate: item.querySelector('.cert-expiryDate').value
                })),
                // existing experience and education fields
                experience: Array.from(document.querySelectorAll('.experience-item')).map(item => ({
                    company: item.querySelector('.company').value,
                    position: item.querySelector('.position').value,
                    duration: item.querySelector('.duration').value,
                    description: item.querySelector('.description').value
                })),
                education: Array.from(document.querySelectorAll('.education-item')).map(item => ({
                    institution: item.querySelector('.institution').value,
                    degree: item.querySelector('.degree').value,
                    field: item.querySelector('.field').value,
                    year: item.querySelector('.year').value
                })),
                // ADDED: New dynamic fields: Job Preferences, Languages, Social Media, Volunteer Experience, Projects
                preferredjobroles: document.getElementById('preferredjobroles').value,  // ADDED
                industries: document.getElementById('industries').value,              // ADDED
                employmenttype: document.getElementById('employmenttype').value,        // ADDED
                preferredlocations: document.getElementById('preferredlocations').value, // ADDED
                languages: Array.from(document.querySelectorAll('.language-item')).map(item => ({
                    name: item.querySelector('.language-name').value,
                    proficiency: item.querySelector('.language-proficiency').value
                })),
                socialmedia: Array.from(document.querySelectorAll('.social-item')).map(item => ({
                    platform: item.querySelector('.social-platform').value,
                    link: item.querySelector('.social-link').value
                })),
                volunteer: Array.from(document.querySelectorAll('.volunteer-item')).map(item => ({
                    role: item.querySelector('.volunteer-role').value,
                    organisation: item.querySelector('.volunteer-org').value,
                    description: item.querySelector('.volunteer-desc').value
                })),
                projects: Array.from(document.querySelectorAll('.project-item')).map(item => ({
                    name: item.querySelector('.project-name').value,
                    description: item.querySelector('.project-desc').value,
                    link: item.querySelector('.project-link').value
                }))
                
            };
        }

        function addSkill() {
            // Predefined list of skills
            const skillOptions = 
            ['3D Modeling', 'Adaptability', 'Adobe Illustrator', 'Adobe Photoshop', 'Adobe XD', 
                'Agile Methodology', 'AI (Artificial Intelligence)', 'Algorithms', 'Android Development', 
                'Angular', 'Asana', 'AWS', 'Big Data', 'Blockchain', 'Business Intelligence', 'C#', 'C++', 
                'Cloud Computing', 'Communication', 'Computer Vision', 'Content Writing', 'Copywriting', 
                'Creativity', 'Critical Thinking', 'Cryptocurrency', 'Cryptography', 'Customer Service', 
                'Cybersecurity', 'Data Analytics', 'Data Science', 'Data Structures', 'Data Visualization', 
                'Database Management', 'Decision Making', 'Deep Learning', 'Debugging', 'DevOps', 
                'Django', 'Drive', 'Economics', 'E-commerce', 'Emotional Intelligence', 'Excel', 
                'Express.js', 'Figma', 'Finance', 'Firebase', 'Flask', 'Functional Programming', 
                'Game Development', 'Go', 'Google Cloud Platform', 'Graphic Design', 'HR & Recruitment', 
                'HTML', 'Investment Banking', 'iOS Development', 'JIRA', 'Java', 'JavaScript', 
                'Kanban', 'Kotlin', 'Leadership', 'Linux', 'Machine Learning', 'Marketing', 
                'Mathematics', 'Mobile App Development', 'MongoDB', 'Natural Language Processing', 
                'Negotiation Skills', 'Networking', 'NoSQL', 'Node.js', 'Object-Oriented Programming', 
                'Penetration Testing', 'PHP', 'PostgreSQL', 'Power BI', 'Presentation Skills', 
                'Problem Solving', 'Project Management', 'Public Speaking', 'Python', 'React', 
                'Ruby on Rails', 'Rust', 'Sales', 'Scrum', 'SEO', 'Shell Scripting', 'Smart Contracts', 
                'Software Testing', 'Spring Boot', 'SQL', 'SQL Optimization', 'Statistics', 
                'Supply Chain Management', 'Swift', 'System Design', 'Tableau', 'Teamwork', 
                'Time Management', 'Trelo', 'TypeScript', 'UI/UX Design', 'Unreal Engine', 'Video Editing', 
                'Vue.js', 'Web3'
            ];

            const searchInput = document.getElementById('skillSearch');
            const dropdown = document.getElementById('skillDropdown');
            let selectedSkill = null;

            // Populate the dropdown with all skills
            function populateDropdown(filteredSkills) {
                dropdown.innerHTML = filteredSkills.map(skill => `<li>${skill}</li>`).join('');
                dropdown.style.display = filteredSkills.length > 0 ? 'block' : 'none';
            }

            // Initially hide the dropdown
            dropdown.style.display = 'none';

            // Show the dropdown when the search input is clicked
            searchInput.addEventListener('focus', () => {
                populateDropdown(skillOptions); // Populate with all skills initially
                dropdown.style.display = 'block';
            });

            // Add event listener to the search input for real-time filtering
            searchInput.addEventListener('input', () => {
                const searchTerm = searchInput.value.toLowerCase();
                const filteredSkills = skillOptions.filter(skill => skill.toLowerCase().includes(searchTerm));
                populateDropdown(filteredSkills);
            });

            // Handle dropdown item selection
            dropdown.addEventListener('click', (e) => {
                if (e.target.tagName === 'LI') {
                    selectedSkill = e.target.textContent;
                    searchInput.value = selectedSkill; // Set the selected skill in the input
                    dropdown.style.display = 'none'; // Hide the dropdown
                }
            });

            // Hide the dropdown when clicking outside the modal or dropdown
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.searchable-dropdown') && e.target !== searchInput) {
                    dropdown.style.display = 'none';
                }
            });

            // Show the modal
            const modal = document.getElementById('skillModal');
            modal.style.display = 'flex';

            // Handle the confirmation button click
            document.getElementById('confirmSkillButton').onclick = () => {
                // Ensure a valid skill is selected
                if (!selectedSkill) {
                    alert('Please select a skill.');
                    return;
                }

                // Check if the skill is already added
                if (profileData.skills.some(skill => skill.name === selectedSkill)) {
                    alert('This skill is already added.');
                } else {
                    // Add the selected skill to the profileData.skills array
                    const skill = {
                        name: selectedSkill,
                        verified: false, // Default value
                        progress: null, // Will be determined from testscore later
                        testScore: null // Will be determined from testscore later
                    };
                    profileData.skills.push(skill);

                    // Re-render the skills list to include the new skill
                    renderSkills();

                    // Provide feedback
                    alert(`Skill "${selectedSkill}" added successfully!`);
                }

                // Hide the modal
                modal.style.display = 'none';
            };

            // Handle the cancel button click
            document.getElementById('cancelSkillButton').onclick = () => {
                modal.style.display = 'none';
            };
        }

        function renderSkills() {
            const skillsContainer = document.getElementById('skillsContainer');
            skillsContainer.innerHTML = profileData.skills.map((skill, index) => `
                <div class="skill-tag">
                    <span data-verified="${skill.verified}">${skill.name}</span>
                    <button type="button" class="remove-skill">×</button>
                </div>
            `).join('');

            // Add event listeners for the remove buttons
            skillsContainer.querySelectorAll('.remove-skill').forEach((btn, index) => {
                btn.addEventListener('click', () => {
                    showRemoveSkillModal(index);
                });
            });
        }

        // ADDED: Remove Item Warning Function
        function showRemoveSkillModal(skillIndex) {
            const modal = document.getElementById('removeSkillModal');
            const confirmButton = document.getElementById('confirmRemoveSkillButton');
            const cancelButton = document.getElementById('cancelRemoveSkillButton');

            // Show the modal
            modal.style.display = 'flex';

            // Handle "Remove Skill" button click
            confirmButton.onclick = () => {
                // Remove the skill from the profileData.skills array
                profileData.skills.splice(skillIndex, 1);

                // Re-render the skills list
                renderSkills();

                // Close the modal
                modal.style.display = 'none';
            };

            // Handle "Keep Skill" button click
            cancelButton.onclick = () => {
                // Close the modal without removing the skill
                modal.style.display = 'none';
            };
        }


        // ADDED: Certification Handling (Using same format as addEducation())
        function addCertification() {
            const newCert = document.createElement('div');
            newCert.className = 'certification-item';
            newCert.innerHTML = `
                <input type="text" class="edit-mode cert-name" placeholder="Certificate Name">
                <input type="text" class="edit-mode cert-institution" placeholder="Certifying Institution">
                <input type="date" class="edit-mode cert-issueDate" placeholder="Issue Date">
                <input type="date" class="edit-mode cert-expiryDate" placeholder="Expiry Date (Optional)">
                <button type="button" class="remove-item">Remove</button>
            `;
            document.getElementById('certificationsContainer').appendChild(newCert);
            newCert.querySelector('.remove-item').addEventListener('click', removeItem);
        }

        // ADDED: Languages Handling (Using same format as addEducation())
        function addLanguage() {
            const newLang = document.createElement('div');
            newLang.className = 'language-item';
            newLang.innerHTML = `
                <input type="text" class="edit-mode language-name" placeholder="Language">
                <input type="text" class="edit-mode language-proficiency" placeholder="Proficiency">
                <button type="button" class="remove-item">Remove</button>
            `;
            document.getElementById('languagesContainer').appendChild(newLang);
            newLang.querySelector('.remove-item').addEventListener('click', removeItem);
        }

        // ADDED: Social Media Handling (Using same format as addEducation())
        function addSocialmedia() {
            const newSM = document.createElement('div');
            newSM.className = 'social-item';
            newSM.innerHTML = `
                <input type="text" class="edit-mode social-platform" placeholder="Platform Name">
                <input type="text" class="edit-mode social-link" placeholder="Profile Link">
                <button type="button" class="remove-item">Remove</button>
            `;
            document.getElementById('socialmediaContainer').appendChild(newSM);
            newSM.querySelector('.remove-item').addEventListener('click', removeItem);
        }

        // ADDED: Volunteer Experience Handling (Using same format as addEducation())
        function addVolunteer() {
            const newVol = document.createElement('div');
            newVol.className = 'volunteer-item';
            newVol.innerHTML = `
                <input type="text" class="edit-mode volunteer-role" placeholder="Role Title">
                <input type="text" class="edit-mode volunteer-org" placeholder="Organisation">
                <textarea class="edit-mode volunteer-desc" placeholder="Description" rows="3"></textarea>
                <button type="button" class="remove-item">Remove</button>
            `;
            document.getElementById('volunteerContainer').appendChild(newVol);
            newVol.querySelector('.remove-item').addEventListener('click', removeItem);
        }


        // ADDED: Projects & Portfolio Handling (Using same format as addEducation())
        function addProject() {
            const newProj = document.createElement('div');
            newProj.className = 'project-item';
            newProj.innerHTML = `
                <input type="text" class="edit-mode project-name" placeholder="Project Name">
                <textarea class="edit-mode project-desc" placeholder="Short Description" rows="3"></textarea>
                <input type="text" class="edit-mode project-link" placeholder="Project Link">
                <button type="button" class="remove-item">Remove</button>
            `;
            document.getElementById('projectsContainer').appendChild(newProj);
            newProj.querySelector('.remove-item').addEventListener('click', removeItem);
        }

        function addExperience() {
            const newExp = document.createElement('div');
            newExp.className = 'experience-item';
            newExp.innerHTML = `
                <input type="text" class="edit-mode company" placeholder="Company">
                <input type="text" class="edit-mode position" placeholder="Position">
                <input type="text" class="edit-mode duration" placeholder="Duration">
                <textarea class="edit-mode description" placeholder="Description" rows="4"></textarea>
                <button type="button" class="remove-item">Remove</button>
            `;
            document.getElementById('experienceContainer').appendChild(newExp);
            newExp.querySelector('.remove-item').addEventListener('click', removeItem);
        }

        function addEducation() {
            const newEdu = document.createElement('div');
            newEdu.className = 'education-item';
            newEdu.innerHTML = `
                <input type="text" class="edit-mode institution" placeholder="Institution">
                <input type="text" class="edit-mode degree" placeholder="Degree">
                <input type="text" class="edit-mode field" placeholder="Field">
                <input type="integer" class="edit-mode year" placeholder="Graduation Year">
                <button type="button" class="remove-item">Remove</button>
            `;
            document.getElementById('educationContainer').appendChild(newEdu);
            newEdu.querySelector('.remove-item').addEventListener('click', removeItem);
        }

        function removeItem(e) {
            e.target.closest('.skill-tag, .experience-item, .education-item, .certification-item, .language-item, .social-item, .volunteer-item, .project-item').remove();
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await checkAuth();
            await initializeProfile();
            updateNavigation();
            
            document.getElementById('logoutButton').addEventListener('click', async () => {
                await supabase.auth.signOut();
                window.location.href = 'login.html';
            });
        });
    </script>
</body>
</html>