<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Skill Test</title>
<style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .question { margin-bottom: 20px; padding: 10px; border: 1px solid #ccc; border-radius: 8px; }
    button { padding: 10px 15px; font-size: 16px; }
</style>
</head>
<body>

<h1 id="testTitle">Loading Test...</h1>
<div id="questions"></div>
<button id="submitBtn" style="display:none;">Submit Test</button>

<script>
const urlParams = new URLSearchParams(window.location.search);
const skillName = urlParams.get("skill");
document.getElementById("testTitle").innerText = `${skillName} Skill Test`;

async function getQuestions(skill) {
    const prompt = `
        Generate exactly 10 multiple-choice questions with varying levels of difficulty for the skill: ${skill}.
        Output ONLY valid JSON in the following format:
        [
            { "q": "Question text", "options": ["Option1","Option2","Option3","Option4"], "answer": 0 }
        ]
        Do not include explanations or extra text.
    `;

    const response = await fetch("https://router.huggingface.co/v1/chat/completions", {
        method: "POST",
        headers: {
            "Authorization": "Bearer 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",
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            model: "HuggingFaceTB/SmolLM3-3B:hf-inference",
            messages: [{ role: "user", content: prompt }]
        })
    });

    const data = await response.json();

    try {
        const generatedText = data.choices[0].message.content;

        const jsonStart = generatedText.indexOf('[');
        const jsonEnd = generatedText.lastIndexOf(']');

        if (jsonStart === -1 || jsonEnd === -1) {
            throw new Error("No JSON array found in the response");
        }

        const jsonString = generatedText.substring(jsonStart, jsonEnd + 1);
        return JSON.parse(jsonString);

    } catch (e) {
        alert("Error parsing AI response.");
        console.error(e, data);
        return [];
    }
}








function renderQuestions(questions) {
    const container = document.getElementById("questions");
    container.innerHTML = "";
    questions.forEach((q, index) => {
        const div = document.createElement("div");
        div.className = "question";
        div.innerHTML = `<p><b>${index+1}. ${q.q}</b></p>` +
            q.options.map(opt => 
                `<label><input type="radio" name="q${index}" value="${opt}"> ${opt}</label><br>`
            ).join("");
        container.appendChild(div);
    });
    document.getElementById("submitBtn").style.display = "inline-block";
}

document.getElementById("submitBtn").addEventListener("click", () => {
    alert("Test submitted! (Here you can send results to Supabase)");
});

(async () => {
    const questions = await getQuestions(skillName);
    if (questions.length > 0) {
        renderQuestions(questions);
    } else {
        document.getElementById("questions").innerText = "Failed to load questions.";
    }
})();
</script>
</body>
</html>
